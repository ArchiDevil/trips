{% extends 'base.html' %} {% block content %}

<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

<script>
    $(function () {
        $('#daterange').daterangepicker({
            autoApply: true,
            autoUpdateInput: true,
            startDate: "{{ trip['from_date'].strftime('%d-%m-%Y') if trip else today_date }}",
            endDate: "{{ trip['till_date'].strftime('%d-%m-%Y') if trip else today_date }}",
            locale: {
                format: "DD-MM-YYYY",
                separator: " - ",
                daysOfWeek: [
                    "{{ string_table['Sunday dp'] }}",
                    "{{ string_table['Monday dp'] }}",
                    "{{ string_table['Tuesday dp'] }}",
                    "{{ string_table['Wednesday dp'] }}",
                    "{{ string_table['Thursday dp'] }}",
                    "{{ string_table['Friday dp'] }}",
                    "{{ string_table['Saturday dp'] }}"
                ],
                "monthNames": [
                    "{{ string_table['January dp'] }}",
                    "{{ string_table['February dp'] }}",
                    "{{ string_table['March dp'] }}",
                    "{{ string_table['April dp'] }}",
                    "{{ string_table['May dp'] }}",
                    "{{ string_table['June dp'] }}",
                    "{{ string_table['July dp'] }}",
                    "{{ string_table['August dp'] }}",
                    "{{ string_table['September dp'] }}",
                    "{{ string_table['October dp'] }}",
                    "{{ string_table['November dp'] }}",
                    "{{ string_table['December dp'] }}"
                ],
                "firstDay": 1
            }
        }, function (start, end, label) {
            const dates = start.format(this.locale.format) + this.locale.separator + end.format(this.locale.format)
            mountedApp.setTripDates(dates)
        });
    });

    var initialName = "{{ trip['name'] if trip else '' }}"
    var initialDates = "{{ trip['from_date'].strftime('%d-%m-%Y') if trip else today_date }} - {{ trip['till_date'].strftime('%d-%m-%Y') if trip else today_date }}"
    function getInitialGroups() {
        return [
            {% if groups: %} {% for group in groups: %}
            { id: {{ loop.index }}, number: {{ loop.index }}, name: 'group{{ loop.index }}', count: {{ group }} },
            {% endfor %} {% endif %}
        ]
    }
</script>

<div id="edit-app" class="container">
    <div class="row my-3">
        <div class="col"></div>
        <div class="col-xl-6 col-lg-7 col-md-9 col-xs-12">
            <form class="p-4 m-3 border shadow bg-white" id="input-form" action="{{ submit_url }}" method="POST" novalidate>
                {% with messages = get_flashed_messages() %}
                {% if messages %}
                {% for message in messages %}
                <div class="alert alert-danger" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <h2 class="text-center my-3">{{ caption }}</h2>

                <div class="form-group">
                    <label for="input-name">{{ string_table['Trips edit title field'] }}</label>
                    <input type="text" class="form-control"
                           id="input-name" name="name"
                           aria-describedby="name-help" placeholder="{{ string_table['Trips edit title placeholder'] }}"
                           autofocus autocomplete="off"
                           v-model="tripName"
                           v-bind:class="{ 'is-valid': validation.name, 'is-invalid': !validation.name }">
                    <div class="invalid-feedback">{{ string_table['Trips edit error empty title'] }}</div>
                </div>

                <div class="form-group">
                    <label for="input-date">{{ string_table['Trips edit dates field'] }}</label>
                    <div id="daterange" class="form-control btn-outline-secondary" style="cursor: pointer;">
                        {% raw %}
                        {{ tripDates }}
                        {% endraw %}
                    </div>
                </div>

                <input class="d-none" name="daterange" v-model="tripDates">

                <div class="form-group">
                    <p class="font-weight-bold mt-4 mb-1">{{ string_table['Trips edit groups config section'] }}</p>
                    <label for="input-attendees">{{ string_table['Trips edit groups field'] }}</label>
                    <select class="custom-select" @change="changeGroups()"
                            v-model="selectedGroupsCount"
                            v-bind:class="{ 'is-valid': validation.groupsSelector, 'is-invalid': !validation.groupsSelector }">
                        <option value="1">{{ string_table['Trips edit groups count 1'] }}</option>
                        <option value="2">{{ string_table['Trips edit groups count 2'] }}</option>
                        <option value="3">{{ string_table['Trips edit groups count 3'] }}</option>
                        <option value="4">{{ string_table['Trips edit groups count 4'] }}</option>
                        <option value="5">{{ string_table['Trips edit groups count 5'] }}</option>
                    </select>
                    <small class="form-text text-muted">{{ string_table['Trips edit groups description'] }}</small>
                </div>

                <input class="d-none" name="redirect" value="{{ redirect }}">

                <!-- HERE GO GROUPS -->
                <div class="form-group">
                    <user-group
                        v-for="group in groups"
                        v-bind:key="group.id"
                        v-bind:group="group"
                        v-bind:validator="function(n) { return /^[0-9]+$/.test(n) && +n > 0; }"
                        group_name_prefix="{{ string_table['Trips edit group prefix'] }}"
                        error_message="{{ string_table['Trips edit error group count'] }}"
                    ></user-group>
                </div>

                <div class="form-group row">
                    <div class="col-12 col-sm-4 my-2 my-sm-0 pr-sm-1">
                        <button type="submit" class="btn btn-primary w-100">{{ submit_caption }}</button>
                    </div>
                    <div class="col-12 col-sm-4 my-2 my-sm-0 px-sm-1">
                        <a class="btn btn-secondary w-100" href="{{ close_url }}">
                            {{ string_table['Trips edit close button'] }}
                        </a>
                    </div>
                    <div class="col d-none d-sm-block"></div>
                    <div class="col-12 col-sm-auto my-2 my-sm-0 pl-sm-1">
                        {% if archive_button %}
                        <button type="button" class="btn btn-danger w-100" data-toggle="modal" data-target="#archive-modal">
                            <i class="fas fa-archive"></i> <span class="d-inline d-sm-none">{{ string_table['Trips edit archive button'] }}</span>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
        <div class="col"></div>
    </div>

    {% if archive_button %}
    <div class="modal fade" id="archive-modal" tabindex="-1" role="dialog" aria-labelledby="archive-modal-title"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="archive-modal-title">{{ string_table['Trips edit archive modal title'] }}</h5>
                </div>
                <div class="modal-body">
                    <p>{{ string_table['Trips edit archive modal text'] }}</p>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-danger" href="{{ url_for('trips.archive', trip_id=trip['id']) }}">
                        {{ string_table['Trips edit archive modal archive button'] }}
                    </a>
                    <button class="btn btn-secondary" data-dismiss="modal">
                        {{ string_table['Trips edit archive modal close button'] }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<!-- production version, optimized for size and speed -->
<script src="https://unpkg.com/vue@3"></script>
<script type="application/javascript" src="{{ url_for('static', filename='js/trip_edit.js') }}"></script>

{% endblock %}
